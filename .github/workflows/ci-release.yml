name: Build and Release

on:
  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Locate MSBuild.exe
        id: locate_msbuild
        run: |
          $vsPath = & "C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe" -latest -requires Microsoft.Component.MSBuild -find MSBuild\**\Bin\MSBuild.exe
          echo "MSBUILD_PATH=$vsPath" | Out-File -FilePath $env:GITHUB_ENV -Append
        shell: pwsh

      - name: Restore NuGet packages
        run: nuget restore "Simple image server/Simple image server.sln"
        shell: pwsh

      - name: Build with MSBuild (for .NET Framework 4.8)
        run: |
          & "$env:MSBUILD_PATH" "Simple image server/Simple image server.sln" /p:Configuration=Release /p:Platform="Any CPU"
        shell: pwsh

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            **/bin/Release/**

  release:
    runs-on: windows-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: build

      - name: Create release zip (robust)
        run: |
          $tag = "${{ github.ref_name }}"
          mkdir temp
          Copy-Item -Path build/**/* -Destination temp/ -Recurse
          Remove-Item -Path temp/**/*.pdb -Force -ErrorAction SilentlyContinue
          Remove-Item -Path temp/**/*.xml -Force -ErrorAction SilentlyContinue
          Compress-Archive -Path temp\* -DestinationPath "SimpleImageServer-$tag.zip"
        shell: pwsh

      - name: Generate Release Changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configuration: ""
          failOnError: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            SimpleImageServer-*.zip
          name: Release ${{ github.ref_name }}
          body: |
            üéâ This is the release for version ${{ github.ref_name }}!

            What's Changed:
            ${{ steps.changelog.outputs.changelog }}

            ---
            üõ°Ô∏è **Note:**  
            Windows Defender may display a warning when downloading newly built applications that are unsigned.  
            This build is created automatically by GitHub Actions and is safe to use.  
            Signing certificates will be considered for future versions.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
